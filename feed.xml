<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en-US"><generator uri="https://jekyllrb.com/" version="4.1.1">Jekyll</generator><link href="https://vagechirkov.github.io//feed.xml" rel="self" type="application/atom+xml" /><link href="https://vagechirkov.github.io//" rel="alternate" type="text/html" hreflang="en-US" /><updated>2022-04-20T15:22:02+07:00</updated><id>https://vagechirkov.github.io//feed.xml</id><title type="html">Blog</title><subtitle>Hi there 👋! This is my personal website.</subtitle><author><name>Valerii Chirkov</name><email>vagechirkov@gmail.com</email></author><entry><title type="html">Easy and flexible programming pattern for behavioral studies in Unity</title><link href="https://vagechirkov.github.io//event-bus-with-uxf/" rel="alternate" type="text/html" title="Easy and flexible programming pattern for behavioral studies in Unity" /><published>2022-04-19T16:00:00+07:00</published><updated>2022-04-19T16:00:00+07:00</updated><id>https://vagechirkov.github.io//event-bus-with-uxf</id><content type="html" xml:base="https://vagechirkov.github.io//event-bus-with-uxf/"><![CDATA[<p>How to create a script to run a behavioral experiment in Unity? Your first intention might be to connect all elements of the study (e.g., instructions, stimuli) to a script that is often called “MainController”. Then you would be tempted to run an experiment in one huge coroutine. I believe this is acceptable only for a small and easy task. But programming will turn into a nightmare in a larger study. For instance, experiments can include several instructions before specific trials; practice trials that are different from the main trials; several types of tasks in each trial; specific feedback at the end of some trials, you name it! 👹🙀💀 Here I will describe how one can simplify and decouple the code of the experiment. 💪🙌 I will use the <code class="language-plaintext highlighter-rouge">Event Bus</code> programming pattern combined with the <a href="https://github.com/immersivecognition/unity-experiment-framework">Unity Experiment Framework (UXF)</a> to create a fairly complex behavioral experiment.</p>

<h4 id="tldr">tl;dr</h4>
<ul>
  <li>The example project is published <a href="https://github.com/vagechirkov/TemplateEventBusUXF">here</a>. You can test it <a href="https://vagechirkov.github.io/TemplateEventBusUXF/">here</a>.</li>
  <li><a href="https://github.com/vagechirkov/TemplateEventBusUXF/blob/main/Assets/Scripts/ExpEventBus.cs">ExpEventBus.cs</a> and <a href="https://github.com/vagechirkov/TemplateEventBusUXF/blob/main/Assets/Scripts/ExperimentEventTypes.cs">ExperimentEventTypes.cs</a> contain Event Bus related scripts.</li>
  <li><a href="https://github.com/vagechirkov/TemplateEventBusUXF/blob/main/Assets/Scripts/ExperimentManager.cs">ExperimentManager.cs</a> contains the experiment loop that iterates through all the trials in the experiment.</li>
  <li><a href="https://github.com/vagechirkov/TemplateEventBusUXF/blob/main/Assets/Scripts/GenerateExperiment.cs">GenerateExperiment.cs</a> is a script to generate UXF session content.</li>
  <li>When the global event (e.g. “ActionBegin”) is published, all the subscribed functions in any script in the project are triggered. This allows to decouple and simplify the code.</li>
</ul>

<h4 id="experiment-">Experiment 🦅</h4>
<p>I will use a mock experiment in which participants are instructed to steer a bird. The task is to keep the bird (the avatar) in the center of a flock. The experiment consists of a practice trial, where the avatar is steering the flock without the flock around, and several main trials in which the avatar is among the flock. The trial consists of the instruction, the bird steering part, and the evaluation of performance. You can look at the actual experiment <a href="https://vagechirkov.github.io/TemplateEventBusUXF/">here</a>. I believe that many behavioral experiments have a similar structure. To simulate the flocking birds, I used a <a href="https://assetstore.unity.com/packages/3d/characters/animals/simple-boids-flocks-of-birds-fish-and-insects-164188">free unity asset</a> developed by <a href="https://assetstore.unity.com/publishers/30428">Nicholas Veselov</a>.</p>

<figure>
<img src="/event-bus-with-uxf/unity-editor.png" alt="the experiment scene in Unity Editor" />
<figcaption>The experiment scene in Unity Editor</figcaption>
</figure>

<h4 id="event-bus-">Event Bus 🚌</h4>
<p>Event Bus is a simple programming pattern that allows the creation of <strong>globally broadcasted events</strong>. One can <strong>subscribe</strong> functions from any part of the project to these events, so that when the event is <strong>published</strong> the necessary function will be triggered. Events can be published from any script in the project and are independent of the subscribed functions. The main benefit is that one can subscribe as many functions in the separate scripts to a specific event as one needs. As soon as this event is published, all these functions will be triggered <strong>simultaneously</strong>.</p>

<p>To learn more about the Event Bus, check chapter 6 in Game Development Patterns with Unity 2021 (code is available <a href="https://github.com/PacktPublishing/Game-Development-Patterns-with-Unity-2021-Second-Edition/tree/main/Assets/Chapters/Chapter06">here</a> with the <a href="https://youtu.be/rGaXu0bnoOQ">video demonstration</a>).</p>

<h4 id="unity-experiment-framework-uxf">Unity Experiment Framework (UXF)🧪</h4>

<p>UXF is a nice and robust framework for developing behavioral experiments in Unity. It allows to create an experiment structure using <strong>Trials</strong> and <strong>Blocks</strong>, store <strong>settings</strong> for each trial, block, or the whole session, and record participant’s behavior. It has its own event system that is connected to the beginning and the end of the trial. In this post, I will present how to extend UXF event system using the Event Bus programming pattern. To get more information check <a href="https://github.com/immersivecognition/unity-experiment-framework">UXF GitHub repo</a>.</p>

<h4 id="publish-and-subscribe">Publish and Subscribe📢</h4>

<p>Let’s look closer at how to use the Event Bus programming pattern. One particularly nice example in the project is the <a href="https://github.com/vagechirkov/TemplateEventBusUXF/blob/main/Assets/Scripts/BackgroundController.cs"><code class="language-plaintext highlighter-rouge">BackgroundController</code></a>. Let’s say you want to have a white background throughout the whole experiment and turn it off only when there is an action or practice task. The only thing you will need is to switch off the canvas when <code class="language-plaintext highlighter-rouge">ActionBegin</code> or <code class="language-plaintext highlighter-rouge">PracticeBegin</code> are published and turn it on again at the beginning of the performance evaluation (<code class="language-plaintext highlighter-rouge">EvaluationBegin </code>). Here is the code:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">BackgroundController</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">Canvas</span> <span class="n">canvas</span><span class="p">;</span>

    <span class="k">void</span> <span class="nf">OnEnable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">ExpEventBus</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">ExpEvents</span><span class="p">.</span><span class="n">ActionBegin</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">canvas</span><span class="p">.</span><span class="n">enabled</span> <span class="p">=</span> <span class="k">false</span><span class="p">);</span>
        <span class="n">ExpEventBus</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">ExpEvents</span><span class="p">.</span><span class="n">PracticeBegin</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">canvas</span><span class="p">.</span><span class="n">enabled</span> <span class="p">=</span> <span class="k">false</span><span class="p">);</span>
        <span class="n">ExpEventBus</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">ExpEvents</span><span class="p">.</span><span class="n">EvaluationBegin</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">canvas</span><span class="p">.</span><span class="n">enabled</span> <span class="p">=</span> <span class="k">true</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note that the background controller is completely isolated from other scripts. If you don’t need it anymore, you can easily delete it without breaking an experiment.</p>

<p>Now let’s look at how one can publish an event. This is illustrated in the <a href="https://github.com/vagechirkov/TemplateEventBusUXF/blob/main/Assets/Scripts/Evaluation.cs">performance evaluation script</a>.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine.UI</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Evaluation</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">GameObject</span> <span class="n">evaluationPanel</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">Slider</span> <span class="n">slider</span><span class="p">;</span>
    <span class="k">void</span> <span class="nf">OnEnable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">ExpEventBus</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">ExpEvents</span><span class="p">.</span><span class="n">EvaluationBegin</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nf">StartCoroutine</span><span class="p">(</span><span class="nf">EvaluatePerformance</span><span class="p">()));</span>
    <span class="p">}</span>

    <span class="n">IEnumerator</span> <span class="nf">EvaluatePerformance</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">evaluationPanel</span><span class="p">.</span><span class="nf">SetActive</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="nf">WaitUntil</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">evaluationPanel</span><span class="p">.</span><span class="n">activeSelf</span><span class="p">);</span>
        <span class="n">ExpEventBus</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="n">ExpEvents</span><span class="p">.</span><span class="n">EvaluationEnd</span><span class="p">);</span>
        <span class="n">slider</span><span class="p">.</span><span class="k">value</span> <span class="p">=</span> <span class="m">0.5f</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">EvaluatePerformance</code> coroutine begins when the <code class="language-plaintext highlighter-rouge">EvaluationBegin</code> event is published. After the evaluation is finished, <code class="language-plaintext highlighter-rouge">EvaluationEnd</code> is published.</p>

<p>🔥🔥🔥 <strong>So, one needs one line of code to publish or subscribe to an event!!</strong> 🔥🔥🔥</p>

<h4 id="experiment-loop">Experiment Loop</h4>

<p>After subscribing all the functions to the corresponding events, we can set up an experiment loop that will be started at the beginning of the study. You can find it in the <a href="https://github.com/vagechirkov/TemplateEventBusUXF/blob/main/Assets/Scripts/ExperimentManager.cs">Experiment Manager</a> script. For each trial we will do the following:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// start UXF trial</span>
<span class="n">trial</span><span class="p">.</span><span class="nf">Begin</span><span class="p">();</span>

<span class="c1">// start instruction at the beginning of the trial</span>
<span class="n">ExpEventBus</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="n">ExpEvents</span><span class="p">.</span><span class="n">InstStartBegin</span><span class="p">);</span>

<span class="c1">// wait for instruction to finish</span>
<span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="nf">WaitUntil</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">_isInstStartFinished</span><span class="p">);</span>

<span class="c1">// start action event</span>
<span class="n">ExpEventBus</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="n">trial</span><span class="p">.</span><span class="n">number</span> <span class="p">==</span> <span class="m">1</span> <span class="p">?</span> <span class="n">ExpEvents</span><span class="p">.</span><span class="n">PracticeBegin</span> <span class="p">:</span> <span class="n">ExpEvents</span><span class="p">.</span><span class="n">ActionBegin</span><span class="p">);</span>

<span class="c1">// wait for action to finish</span>
<span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="nf">WaitForSeconds</span><span class="p">(</span><span class="m">10f</span><span class="p">);</span>
<span class="n">ExpEventBus</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="n">trial</span><span class="p">.</span><span class="n">number</span> <span class="p">==</span> <span class="m">1</span> <span class="p">?</span> <span class="n">ExpEvents</span><span class="p">.</span><span class="n">PracticeEnd</span> <span class="p">:</span> <span class="n">ExpEvents</span><span class="p">.</span><span class="n">ActionEnd</span><span class="p">);</span>

<span class="c1">// start evaluation at the end of the trial</span>
<span class="n">ExpEventBus</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="n">ExpEvents</span><span class="p">.</span><span class="n">EvaluationBegin</span><span class="p">);</span>

<span class="c1">// wait for evaluation to finish</span>
<span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="nf">WaitUntil</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">_isEvaluationFinished</span><span class="p">);</span>

<span class="n">_isInstStartFinished</span> <span class="p">=</span> <span class="n">_isEvaluationFinished</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

<span class="c1">// end UXF trial</span>
<span class="n">trial</span><span class="p">.</span><span class="nf">End</span><span class="p">();</span>
<span class="k">yield</span> <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
</code></pre></div></div>

<p>Note that the <code class="language-plaintext highlighter-rouge">EvaluationEnd</code> and <code class="language-plaintext highlighter-rouge">InstStartEnd</code> events are published in the other scripts. Once they are published, the boolean variables<code class="language-plaintext highlighter-rouge">_isInstStartFinished</code> and <code class="language-plaintext highlighter-rouge">_isEvaluationFinished</code> variables become <code class="language-plaintext highlighter-rouge">true</code> and the loop continues. Importantly, there are <strong>no direct connections</strong> between the <a href="https://github.com/vagechirkov/TemplateEventBusUXF/blob/main/Assets/Scripts/Evaluation.cs">evaluation</a>/<a href="https://github.com/vagechirkov/TemplateEventBusUXF/blob/main/Assets/Scripts/Instructions.cs">instruction</a> and the <a href="https://github.com/vagechirkov/TemplateEventBusUXF/blob/main/Assets/Scripts/ExperimentManager.cs">experiment manager</a> scripts.</p>

<figure>
<img src="/event-bus-with-uxf/game_sample.gif" alt="the experiment trial sample" />
</figure>

<h3 id="materials-and-recourses">Materials and recourses</h3>

<ul>
  <li>Baron, D. (2021). Game Development Patterns with Unity 2021: Explore practical game development using software design patterns and best practices in Unity and C#, 2nd Edition (2nd ed. edition). Packt Publishing. <a href="https://www.packtpub.com/product/game-development-patterns-with-unity-2021-second-edition/9781800200814">link</a></li>
  <li>Brookes, J., Warburton, M., Alghadier, M., Mon-Williams, M., &amp; Mushtaq, F. (2020). Studying human behavior with virtual reality: The Unity Experiment Framework. Behavior Research Methods, 52(2), 455–463. https://doi.org/10.3758/s13428-019-01242-0; See on <a href="https://github.com/immersivecognition/unity-experiment-framework">GitHub</a></li>
  <li><a href="https://youtu.be/oc3sQamIh-Q">Events or UnityEvents?????????</a> by
Jason Weimann</li>
  <li>Simple Boids (Flocks of Birds, Fish and Insects) by <a href="https://assetstore.unity.com/publishers/30428">Nicholas Veselov</a>; See in <a href="https://assetstore.unity.com/packages/3d/characters/animals/simple-boids-flocks-of-birds-fish-and-insects-164188">Unity asset store</a>.</li>
</ul>]]></content><author><name>Valerii Chirkov</name><email>vagechirkov@gmail.com</email></author><category term="unity" /><category term="behavioral experiments" /><category term="unity" /><category term="uxf" /><summary type="html"><![CDATA[How to create a script to run a behavioral experiment in Unity? Your first intention might be to connect all elements of the study (e.g., instructions, stimuli) to a script that is often called “MainController”. Then you would be tempted to run an experiment in one huge coroutine. I believe this is acceptable only for a small and easy task. But programming will turn into a nightmare in a larger study. For instance, experiments can include several instructions before specific trials; practice trials that are different from the main trials; several types of tasks in each trial; specific feedback at the end of some trials, you name it! 👹🙀💀 Here I will describe how one can simplify and decouple the code of the experiment. 💪🙌 I will use the Event Bus programming pattern combined with the Unity Experiment Framework (UXF) to create a fairly complex behavioral experiment.]]></summary></entry></feed>